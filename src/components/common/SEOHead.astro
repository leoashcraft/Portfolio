---
import { profile } from '../../data/profile';
import { seo, schema } from '../../data/seo';
import { experience, education, certifications } from '../../data/experience';
import { projects } from '../../data/projects';
import { services, skills } from '../../data/skills';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article' | 'profile';
  publishedTime?: Date;
  modifiedTime?: Date;
  tags?: string[];
  noindex?: boolean;
}

const {
  title,
  description = profile.description,
  image = '/img/pic.webp',
  type = 'website',
  publishedTime,
  modifiedTime,
  tags = [],
  noindex = false,
} = Astro.props;

const pageTitle = title ? `Leo Ashcraft | ${title}` : seo.siteTitle;
const metaDescription = description || seo.siteDescription;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const imageURL = new URL(image, Astro.site);
const siteUrl = Astro.site?.href || 'https://leoashcraft.com';

// Helper to create ISO date from YYYY-MM format
const toISODate = (dateStr: string) => {
  if (dateStr === 'Current') return undefined;
  const [year, month] = dateStr.split('-');
  return `${year}-${month || '01'}-01`;
};

// JSON-LD: Educational Credentials (Education + Certifications)
const credentialSchemas = [
  ...education.map((edu) => ({
    '@type': 'EducationalOccupationalCredential',
    name: edu.degree,
    credentialCategory: edu.degree.includes('Certificate') ? 'Certificate' :
                        edu.degree.includes('Bootcamp') ? 'Certificate' : 'Diploma',
    educationalLevel: edu.degree.includes('High School') ? 'HighSchool' : 'PostSecondary',
    recognizedBy: {
      '@type': 'EducationalOrganization',
      name: edu.institution,
    },
    dateCreated: `${edu.year}-01-01`,
    ...(edu.credentialUrl && { url: edu.credentialUrl }),
  })),
  ...certifications.map((cert) => ({
    '@type': 'EducationalOccupationalCredential',
    name: cert.name,
    credentialCategory: 'Certificate',
    recognizedBy: {
      '@type': 'Organization',
      name: cert.issuer,
    },
    dateCreated: `${cert.year}-01-01`,
  })),
];

// JSON-LD: Work Experience as Occupations
const occupationSchemas = experience.map((job) => ({
  '@type': 'Occupation',
  name: job.position,
  occupationLocation: job.location ? {
    '@type': 'Place',
    address: {
      '@type': 'PostalAddress',
      addressLocality: job.location.split(', ')[0],
      addressRegion: job.location.split(', ')[1] || '',
    },
  } : undefined,
  hiringOrganization: {
    '@type': 'Organization',
    name: job.company,
  },
  description: job.highlights.join(' '),
  skills: job.highlights.join(', '),
}));

// JSON-LD: Enhanced Person Schema
const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  '@id': schema.personId,
  name: profile.name,
  url: siteUrl,
  image: new URL(profile.photoUrl, Astro.site).href,
  description: 'Full-stack software developer with 5+ years of development experience and 17+ years in technology. Specializes in PHP, React, and Salesforce integrations. Based in Dallasâ€“Fort Worth.',
  jobTitle: schema.jobTitle,
  address: {
    '@type': schema.address.type,
    addressLocality: schema.address.addressLocality,
    addressRegion: schema.address.addressRegion,
    addressCountry: schema.address.addressCountry,
  },
  worksFor: {
    '@type': schema.worksFor.type,
    name: schema.worksFor.name,
    url: schema.worksFor.url,
  },
  alumniOf: education.map((edu) => ({
    '@type': 'EducationalOrganization',
    name: edu.institution,
  })),
  hasCredential: credentialSchemas,
  hasOccupation: occupationSchemas,
  knowsAbout: [...new Set([...schema.knowsAbout, ...skills.flatMap(cat => cat.skills.map(s => s.name))])],
  sameAs: schema.sameAs,
};

// JSON-LD: WebSite Schema
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  '@id': `${siteUrl}#website`,
  name: seo.siteTitle,
  url: siteUrl,
  author: { '@id': schema.personId },
  description: seo.siteDescription,
};

// JSON-LD: Portfolio/Projects as ItemList of CreativeWork
const portfolioSchema = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  '@id': `${siteUrl}#portfolio`,
  name: 'Portfolio Projects',
  description: 'Software development projects by Leo Ashcraft',
  numberOfItems: projects.length,
  itemListElement: projects.map((project, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    item: {
      '@type': 'SoftwareApplication',
      name: project.title,
      description: project.description,
      image: new URL(project.image, Astro.site).href,
      applicationCategory: 'WebApplication',
      operatingSystem: 'Web Browser',
      author: { '@id': schema.personId },
      ...(project.live && { url: project.live }),
      ...(project.github && {
        codeRepository: project.github,
        isAccessibleForFree: true,
      }),
      keywords: project.tags.join(', '),
    },
  })),
};

// JSON-LD: Services Offered
const servicesSchema = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  '@id': `${siteUrl}#services`,
  name: 'Professional Services',
  description: 'Software development services offered by Leo Ashcraft',
  numberOfItems: services.length,
  itemListElement: services.map((service, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    item: {
      '@type': 'Service',
      name: service.title,
      description: service.description.replace(/<[^>]*>/g, ''), // Strip HTML tags
      provider: { '@id': schema.personId },
      areaServed: {
        '@type': 'Place',
        name: 'Worldwide',
      },
      hasOfferCatalog: {
        '@type': 'OfferCatalog',
        name: service.title,
        itemListElement: service.features.map((feature) => ({
          '@type': 'Offer',
          itemOffered: {
            '@type': 'Service',
            name: feature,
          },
        })),
      },
    },
  })),
};

// JSON-LD: Professional Profile Page
const profilePageSchema = {
  '@context': 'https://schema.org',
  '@type': 'ProfilePage',
  '@id': `${siteUrl}#profilepage`,
  name: pageTitle,
  url: siteUrl,
  mainEntity: { '@id': schema.personId },
  dateCreated: '2024-01-01',
  dateModified: new Date().toISOString().split('T')[0],
};

// JSON-LD: Article schema (for blog posts if used)
const articleSchema =
  type === 'article' && publishedTime
    ? {
        '@context': 'https://schema.org',
        '@type': 'BlogPosting',
        headline: title,
        description,
        image: imageURL.href,
        author: { '@id': schema.personId },
        datePublished: publishedTime.toISOString(),
        dateModified: (modifiedTime || publishedTime).toISOString(),
        keywords: tags.join(', '),
      }
    : null;

// Combine all schemas
const schemas = [
  personSchema,
  websiteSchema,
  profilePageSchema,
  portfolioSchema,
  servicesSchema,
  articleSchema,
].filter(Boolean);
---

<!-- Preconnect to external resources (highest priority) -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<title>{pageTitle}</title>
<meta name="title" content={pageTitle} />
<meta name="description" content={metaDescription} />
<meta name="author" content={profile.name} />
<meta
  name="keywords"
  content={seo.keywords}
/>
<link rel="canonical" href={canonicalURL} />

<!-- IndieAuth endpoints -->
<link rel="authorization_endpoint" href="https://indieauth.com/auth" />
<link rel="token_endpoint" href="https://tokens.indieauth.com/token" />

<!-- rel="me" identity links (generated from schema.sameAs) -->
{schema.sameAs.map((url) => (
  <link rel="me" href={url} />
))}

{noindex && <meta name="robots" content="noindex, nofollow" />}

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="/favicon.ico" />
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
<meta name="theme-color" content="#0a0a0f" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={metaDescription} />
<meta property="og:image" content={imageURL} />
<meta property="og:site_name" content={seo.siteTitle} />
<meta property="og:locale" content="en_US" />

{
  type === 'article' && publishedTime && (
    <>
      <meta property="article:published_time" content={publishedTime.toISOString()} />
      {modifiedTime && (
        <meta property="article:modified_time" content={modifiedTime.toISOString()} />
      )}
      {tags.map((tag) => (
        <meta property="article:tag" content={tag} />
      ))}
    </>
  )
}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={canonicalURL} />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={metaDescription} />
<meta name="twitter:image" content={imageURL} />

<!-- JSON-LD Structured Data -->
{
  schemas.map((schema) => (
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  ))
}

<!-- Critical inline styles for fastest FCP -->
<style>
  body{background:#0a0a0f;color:#e5e5e5;font-family:Inter,ui-sans-serif,system-ui,sans-serif}
  .gradient-text-animated{background:linear-gradient(135deg,#facc15,#f97316,#facc15);-webkit-background-clip:text;background-clip:text;color:transparent}
</style>

<!-- Google Fonts (non-render-blocking, display=optional for no layout shift) -->
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400&display=optional"
/>
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400&display=optional"
  rel="stylesheet"
  media="print"
  onload="this.media='all'"
/>
<noscript>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400&display=optional"
    rel="stylesheet"
  />
</noscript>
