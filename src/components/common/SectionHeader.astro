---
interface Props {
  title: string;
  titleHighlight: string;
  subtitle: string;
  headingId?: string;
}

const { title, titleHighlight, subtitle, headingId } = Astro.props;
const subtitleId = headingId ? `${headingId}-subtitle` : `subtitle-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="text-center mb-16 section-header-container">
  <h2 id={headingId} class="section-title">
    {title} <span class="gradient-text">{titleHighlight}</span>
  </h2>
  <p class="section-subtitle mx-auto relative">
    <span class="subtitle-placeholder invisible" aria-hidden="true">{subtitle}</span>
    <span class="subtitle-typewriter absolute left-0 right-0 top-0">
      <span class="subtitle-text" data-subtitle={subtitle} id={subtitleId}></span><span class="subtitle-cursor hidden inline-block w-[2px] h-[1em] bg-neon-cyan ml-1 align-middle animate-[cursor-blink_1s_step-end_infinite]"></span>
    </span>
  </p>
</div>

<script>
  import { typePhrase } from '../../lib/typewriter';

  function initSubtitleTypewriters() {
    const containers = document.querySelectorAll('.section-header-container');

    // Check if animations are disabled
    const animationsDisabled = document.documentElement.getAttribute('data-animations') === 'disabled';

    containers.forEach((container) => {
      const textEl = container.querySelector('.subtitle-text') as HTMLElement;
      const cursorEl = container.querySelector('.subtitle-cursor') as HTMLElement;

      if (!textEl || textEl.dataset.animated === 'true') return;

      const subtitle = textEl.dataset.subtitle || '';

      // If animations disabled, just show text immediately
      if (animationsDisabled) {
        textEl.textContent = subtitle;
        textEl.dataset.animated = 'true';
        if (cursorEl) {
          cursorEl.classList.add('hidden');
          cursorEl.style.display = 'none';
        }
        return;
      }

      if (!cursorEl) return;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            // Check animations disabled again in case it changed
            if (document.documentElement.getAttribute('data-animations') === 'disabled') {
              textEl.textContent = subtitle;
              textEl.dataset.animated = 'true';
              cursorEl.classList.add('hidden');
              cursorEl.style.display = 'none';
              observer.disconnect();
              return;
            }

            if (entry.isIntersecting && textEl.dataset.animated !== 'true') {
              textEl.dataset.animated = 'true';
              observer.disconnect();

              // Delay to let title animation start first
              setTimeout(() => {
                // Double check animations not disabled during delay
                if (document.documentElement.getAttribute('data-animations') === 'disabled') {
                  cursorEl.classList.add('hidden');
                  cursorEl.style.display = 'none';
                  return;
                }
                cursorEl.classList.remove('hidden');
                typePhrase(textEl, subtitle, () => {
                  // Hide cursor after typing completes
                  setTimeout(() => {
                    cursorEl.style.display = 'none';
                  }, 2000);
                });
              }, 800);
            }
          });
        },
        { threshold: 0.1 }
      );

      observer.observe(container);
    });
  }

  // Handle animations state changes
  function handleAnimationsChange() {
    const animationsDisabled = document.documentElement.getAttribute('data-animations') === 'disabled';
    const containers = document.querySelectorAll('.section-header-container');

    containers.forEach((container) => {
      const textEl = container.querySelector('.subtitle-text') as HTMLElement;
      const cursorEl = container.querySelector('.subtitle-cursor') as HTMLElement;

      if (!textEl) return;

      // Hide cursor
      if (cursorEl) {
        cursorEl.classList.add('hidden');
        cursorEl.style.display = 'none';
      }

      // If animations disabled, show text immediately
      if (animationsDisabled) {
        const subtitle = textEl.dataset.subtitle || '';
        textEl.textContent = subtitle;
        textEl.dataset.animated = 'true';
      }
    });
  }

  initSubtitleTypewriters();
  document.addEventListener('astro:after-swap', initSubtitleTypewriters);
  window.addEventListener('animations-change', handleAnimationsChange);
</script>
