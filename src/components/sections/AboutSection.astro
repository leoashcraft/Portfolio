---
import { services } from '../../data/skills';
import { site } from '../../data/site';
import SectionHeader from '../common/SectionHeader.astro';
import ArcadeDecorations from '../common/ArcadeDecorations.astro';
import Icon from '../ui/Icon.astro';
---

<section id="about" class="section section-arcade px-4 overflow-hidden" aria-labelledby="about-heading">
  <!-- Neon Top Border -->
  <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-neon-cyan/50 to-transparent"></div>

  <!-- Floating Arcade Decorations -->
  <ArcadeDecorations variant="about" />

  <div class="max-w-6xl mx-auto relative z-10">
    <!-- Section Header -->
    <SectionHeader
      title={site.sections.about.title}
      titleHighlight={site.sections.about.titleHighlight}
      subtitle={site.sections.about.subtitle}
      headingId="about-heading"
    />

    {/* Skills Section - COMMENTED OUT
    <div class="mb-20">
      <h3 class="text-2xl font-bold text-white text-center mb-8">
        {site.sections.about.skillsTitle} <span class="gradient-text">{site.sections.about.skillsTitleHighlight}</span>
      </h3>

      <div class="grid md:grid-cols-3 gap-6">
        {
          skills.map((category) => (
            <div class="card">
              <p class="text-lg font-semibold text-white mb-4">
                {category.name}
              </p>
              <div class="space-y-3">
                {category.skills.slice(0, 5).map((skill) => (
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-300">{skill.name}</span>
                      <span class="text-neon-pink">{skill.level}%</span>
                    </div>
                    <div class="h-2 bg-night-700/50 rounded-full overflow-hidden border border-neon-pink/20">
                      <div
                        class="h-full bg-gradient-to-r from-neon-pink via-neon-purple to-neon-orange rounded-full transition-all duration-1000"
                        style={`width: ${skill.level}%; box-shadow: 0 0 10px rgba(255, 0, 255, 0.4);`}
                        role="progressbar"
                        aria-valuenow={skill.level}
                        aria-valuemin="0"
                        aria-valuemax="100"
                        aria-label={`${skill.name}: ${skill.level}%`}
                      />
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))
        }
      </div>
    </div>
    */}

    <!-- Services Section -->
    <div class="services-section">
      <div class="services-container space-y-6">
        {/* First service - full width */}
        <div class="card card-highlighted group service-card service-first">
          <div class="service-icon service-icon-anim w-12 h-12 rounded-xl bg-gradient-to-br from-neon-pink/20 to-neon-purple/20 flex items-center justify-center mb-4 group-hover:from-neon-pink/30 group-hover:to-neon-purple/30 transition-colors border border-neon-pink/20">
            <svg class="w-6 h-6 text-neon-pink" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
          </div>
          <p class="service-card-title text-[24px] font-semibold text-white mb-2" data-title={services[0].title}></p>
          <p class="service-desc text-gray-400 text-[18px] mb-4" set:html={services[0].description}></p>
          <ul class="service-features space-y-2">
            {services[0].features.map((feature, index) => (
              <li class="feature-item flex items-center gap-2 text-[18px] text-gray-300" style={`--feature-index: ${index}`}>
                <Icon name="checkmark" size="sm" class="text-neon-green shrink-0" />
                <span class="feature-text">{feature}</span>
              </li>
            ))}
          </ul>
        </div>

        {/* Middle services - half width each */}
        <div class="service-middle grid md:grid-cols-2 gap-6">
        {
          services.slice(1, 3).map((service, index) => (
            <div class={`card card-highlighted group service-card service-mid-${index}`}>
              <div class="service-icon service-icon-anim w-12 h-12 rounded-xl bg-gradient-to-br from-neon-pink/20 to-neon-purple/20 flex items-center justify-center mb-4 group-hover:from-neon-pink/30 group-hover:to-neon-purple/30 transition-colors border border-neon-pink/20">
                {service.icon === 'code' && (
                  <svg
                    class="w-6 h-6 text-neon-pink"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
                    />
                  </svg>
                )}
                {service.icon === 'cloud' && (
                  <svg
                    class="w-6 h-6 text-neon-yellow"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
                    />
                  </svg>
                )}
                {service.icon === 'puzzle' && (
                  <svg
                    class="w-6 h-6 text-neon-orange"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"
                    />
                  </svg>
                )}
                {service.icon === 'palette' && (
                  <svg
                    class="w-6 h-6 text-neon-cyan"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
                    />
                  </svg>
                )}
              </div>
              <p class="service-card-title text-[24px] font-semibold text-white mb-2" data-title={service.title}>
              </p>
              <p class="service-desc text-gray-400 text-[18px] mb-4" set:html={service.description}></p>
              <ul class="service-features space-y-2">
                {service.features.map((feature, index) => (
                  <li class="feature-item flex items-center gap-2 text-[18px] text-gray-300" style={`--feature-index: ${index}`}>
                    <Icon name="checkmark" size="sm" class="text-neon-green shrink-0" />
                    <span class="feature-text">{feature}</span>
                  </li>
                ))}
              </ul>
            </div>
          ))
        }
        </div>

        {/* Logo & Branding - full width */}
        {services[3] && (
          <div class="card card-highlighted group relative overflow-hidden service-card service-last">
            <div class="service-icon service-icon-anim w-12 h-12 rounded-xl bg-gradient-to-br from-neon-pink/20 to-neon-purple/20 flex items-center justify-center mb-4 group-hover:from-neon-pink/30 group-hover:to-neon-purple/30 transition-colors border border-neon-pink/20">
              <svg
                class="w-6 h-6 text-neon-cyan"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
                />
              </svg>
            </div>
            <p class="service-card-title text-[24px] font-semibold text-white mb-2" data-title={services[3].title}></p>
            <p class="service-desc text-gray-400 text-[18px] mb-4" set:html={services[3].description}></p>
            <div class="logo-gallery grid grid-cols-3 gap-4 md:gap-16 mt-4 px-2 md:px-8">
              <button class="logo-item flex items-center justify-center h-[200px] cursor-pointer logo-thumbnail" data-src="/img/logos/golden-lighting-co.avif" data-alt="Golden Lighting Co. logo">
                <div class="logo-image-wrapper relative">
                  <img src="/img/logos/golden-lighting-co.avif" alt="Golden Lighting Co. logo" class="max-h-[200px] max-w-full object-contain" />
                  <div class="logo-shimmer absolute inset-0 opacity-0 pointer-events-none" style="mask-image: url('/img/logos/golden-lighting-co.avif'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('/img/logos/golden-lighting-co.avif'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;"></div>
                </div>
              </button>
              <button class="logo-item flex items-center justify-center h-[200px] cursor-pointer logo-thumbnail" data-src="/img/logos/honey-bee-window-cleaning.avif" data-alt="Honey Bee Window Cleaning logo">
                <div class="logo-image-wrapper relative">
                  <img src="/img/logos/honey-bee-window-cleaning.avif" alt="Honey Bee Window Cleaning logo" class="max-h-[200px] max-w-full object-contain" />
                  <div class="logo-shimmer absolute inset-0 opacity-0 pointer-events-none" style="mask-image: url('/img/logos/honey-bee-window-cleaning.avif'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('/img/logos/honey-bee-window-cleaning.avif'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;"></div>
                </div>
              </button>
              <button class="logo-item flex items-center justify-center h-[200px] cursor-pointer logo-thumbnail" data-src="/img/logos/eagle-it.avif" data-alt="Eagle IT logo">
                <div class="logo-image-wrapper relative">
                  <img src="/img/logos/eagle-it.avif" alt="Eagle IT logo" class="max-h-[200px] max-w-full object-contain" />
                  <div class="logo-shimmer absolute inset-0 opacity-0 pointer-events-none" style="mask-image: url('/img/logos/eagle-it.avif'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('/img/logos/eagle-it.avif'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;"></div>
                </div>
              </button>
            </div>

            <!-- Image Modal - inside card -->
            <div id="logo-modal" class="absolute inset-0 z-20 hidden items-center justify-center bg-black/90 backdrop-blur-sm rounded-2xl">
              <button id="modal-close" class="absolute top-2 right-2 z-30 text-white text-[3rem] leading-none hover:text-neon-pink transition-colors w-12 h-12 flex items-center justify-center pb-1">&times;</button>
              <img id="modal-image" src="" alt="" class="max-h-[200px] max-w-[80%] object-contain" />
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</section>

<script>
  import { initIconFlips } from '../../lib/icon-flip';
  import { initSectionParallax } from '../../lib/parallax';

  let iconCleanup: () => void;

  function initServiceIconFlips() {
    iconCleanup?.();
    iconCleanup = initIconFlips({ selector: '.service-icon' });
  }

  function initLogoModal() {
    const modal = document.getElementById('logo-modal');
    const modalImage = document.getElementById('modal-image') as HTMLImageElement;
    const modalClose = document.getElementById('modal-close');
    const thumbnails = document.querySelectorAll('.logo-thumbnail');

    if (!modal || !modalImage || !modalClose) return;

    thumbnails.forEach((thumb) => {
      thumb.addEventListener('click', () => {
        const src = thumb.getAttribute('data-src');
        const alt = thumb.getAttribute('data-alt');
        if (src) {
          modalImage.src = src;
          modalImage.alt = alt || '';
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }
      });
    });

    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
    });
  }

  function initLogoShimmer() {
    const wrappers = document.querySelectorAll('.logo-image-wrapper');

    wrappers.forEach((wrapper) => {
      const shimmer = wrapper.querySelector('.logo-shimmer');
      const img = wrapper.querySelector('img');
      if (!shimmer || !img) return;

      let isAnimating = false;

      img.addEventListener('mouseenter', () => {
        if (isAnimating) return;
        isAnimating = true;
        shimmer.classList.add('shimmer-active');
      });

      shimmer.addEventListener('animationend', () => {
        shimmer.classList.remove('shimmer-active');
        isAnimating = false;
      });

      img.addEventListener('mouseleave', () => {
        isAnimating = false;
      });
    });
  }

  function initAbout() {
    initServiceIconFlips();
    initSectionParallax('about');
    initLogoModal();
    initLogoShimmer();
  }

  // Services cascade animation
  let servicesCleanup: (() => void) | undefined;

  interface CardState {
    card: HTMLElement;
    icon: HTMLElement | null;
    title: HTMLElement | null;
    titleText: string;
    desc: HTMLElement | null;
    features: HTMLElement[];
    logos: HTMLElement[];
    lastTitleProgress: number;
  }

  function initServicesCascade() {
    const section = document.querySelector('.services-section') as HTMLElement;
    const container = document.querySelector('.services-container') as HTMLElement;
    if (!section || !container) return () => {};

    const cards = container.querySelectorAll('.service-card') as NodeListOf<HTMLElement>;
    const cardStates: CardState[] = [];

    // Initialize card states
    cards.forEach((card) => {
      const titleEl = card.querySelector('.service-card-title') as HTMLElement;
      const titleText = titleEl?.dataset.title || '';

      cardStates.push({
        card,
        icon: card.querySelector('.service-icon-anim'),
        title: titleEl,
        titleText,
        desc: card.querySelector('.service-desc'),
        features: Array.from(card.querySelectorAll('.feature-item')),
        logos: Array.from(card.querySelectorAll('.logo-item')),
        lastTitleProgress: -1
      });
    });

    // Skip if animations disabled
    if (document.documentElement.getAttribute('data-animations') === 'disabled') {
      container.classList.add('first-in', 'cloud-in', 'crm-in', 'last-in');
      cardStates.forEach((state) => {
        if (state.icon) state.icon.classList.add('visible');
        if (state.title) state.title.textContent = state.titleText;
        if (state.desc) state.desc.classList.add('visible');
        state.features.forEach((f) => f.classList.add('visible'));
        state.logos.forEach((l) => l.classList.add('visible'));
      });
      return () => {};
    }

    let ticking = false;

    const checkServices = () => {
      const viewportHeight = window.innerHeight;
      const firstTrigger = viewportHeight * 0.4;
      const cloudTrigger = viewportHeight * 0.15;
      const crmTrigger = viewportHeight * -0.1;
      const lastTrigger = viewportHeight * -0.35;
      const exitPoint = viewportHeight * 0.7;

      const sectionRect = section.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();

      // Cards appear in sequence
      if (containerRect.top < firstTrigger) {
        container.classList.add('first-in');
      }
      if (containerRect.top < cloudTrigger) {
        container.classList.add('cloud-in');
      }

      // Calculate Cloud's progress to determine when CRM should appear
      const cloudCard = cardStates.find(s => s.card.classList.contains('service-mid-0'));
      let cloudProgress = 0;
      if (cloudCard) {
        const cloudRect = cloudCard.card.getBoundingClientRect();
        const contentStart = viewportHeight * 0.6;
        const contentEnd = viewportHeight * 0.1;
        if (cloudRect.top <= contentStart && cloudRect.top >= contentEnd) {
          cloudProgress = (contentStart - cloudRect.top) / (contentStart - contentEnd);
        } else if (cloudRect.top < contentEnd) {
          cloudProgress = 1;
        }
      }

      // CRM appears when Cloud's checkmarks start (70% of Cloud's progress)
      if (cloudProgress >= 0.70) {
        container.classList.add('crm-in');
      }

      // Logo & Branding appears after CRM is visible and scrolled more
      if (containerRect.top < lastTrigger && container.classList.contains('crm-in')) {
        container.classList.add('last-in');
      }

      // Animate each card's content based on its position
      cardStates.forEach((state) => {
        const cardRect = state.card.getBoundingClientRect();

        // Card content animation range
        const contentStart = viewportHeight * 0.6;
        const contentEnd = viewportHeight * 0.1;

        // Calculate overall progress for this card (0-1)
        let progress = 0;
        if (cardRect.top <= contentStart && cardRect.top >= contentEnd) {
          progress = (contentStart - cardRect.top) / (contentStart - contentEnd);
        } else if (cardRect.top < contentEnd) {
          progress = 1;
        }

        // Icon appears at 0-15% progress
        if (state.icon) {
          if (progress >= 0.05) {
            state.icon.classList.add('visible');
          } else {
            state.icon.classList.remove('visible');
          }
        }

        // Title types at 15-45% progress
        if (state.title && state.titleText) {
          const titleStart = 0.15;
          const titleEnd = 0.45;
          let titleProgress = 0;
          if (progress >= titleStart && progress <= titleEnd) {
            titleProgress = (progress - titleStart) / (titleEnd - titleStart);
          } else if (progress > titleEnd) {
            titleProgress = 1;
          }

          if (Math.abs(titleProgress - state.lastTitleProgress) > 0.01) {
            state.lastTitleProgress = titleProgress;
            if (titleProgress >= 0.95) {
              state.title.textContent = state.titleText;
            } else {
              const charsToShow = Math.floor(titleProgress * state.titleText.length);
              state.title.textContent = state.titleText.slice(0, charsToShow);
            }
          }
        }

        // Description appears at 55% progress (after title finishes at 45%)
        if (state.desc) {
          if (progress >= 0.55) {
            state.desc.classList.add('visible');
          } else {
            state.desc.classList.remove('visible');
          }
        }

        // Features cascade at 70-90% progress (after description)
        const featuresStart = 0.70;
        const featuresEnd = 0.90;
        const featuresRange = featuresEnd - featuresStart;
        state.features.forEach((feature, index) => {
          const featureThreshold = featuresStart + (index / Math.max(state.features.length, 1)) * featuresRange;
          if (progress >= featureThreshold) {
            feature.classList.add('visible');
          } else {
            feature.classList.remove('visible');
          }
        });

        // Logos cascade at 90-100% progress (after features, for logo card only)
        if (state.logos.length > 0) {
          const logosStart = 0.90;
          const logosRange = 0.10;
          state.logos.forEach((logo, index) => {
            const logoThreshold = logosStart + (index / state.logos.length) * logosRange;
            if (progress >= logoThreshold) {
              logo.classList.add('visible');
            } else {
              logo.classList.remove('visible');
            }
          });
        }
      });

      // Reset when scrolling up
      if (sectionRect.top > exitPoint) {
        container.classList.remove('first-in', 'cloud-in', 'crm-in', 'last-in');
        cardStates.forEach((state) => {
          if (state.icon) state.icon.classList.remove('visible');
          if (state.title) state.title.textContent = '';
          state.lastTitleProgress = -1;
          if (state.desc) state.desc.classList.remove('visible');
          state.features.forEach((f) => f.classList.remove('visible'));
          state.logos.forEach((l) => l.classList.remove('visible'));
        });
      }

      ticking = false;
    };

    const handleScroll = () => {
      if (!ticking) {
        requestAnimationFrame(checkServices);
        ticking = true;
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    checkServices();

    return () => {
      window.removeEventListener('scroll', handleScroll);
    };
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAbout);
  } else {
    initAbout();
  }
  document.addEventListener('astro:after-swap', initAbout);

  function initServicesAnim() {
    servicesCleanup?.();
    servicesCleanup = initServicesCascade();
  }

  initServicesAnim();
  document.addEventListener('astro:after-swap', initServicesAnim);

  window.addEventListener('animations-change', () => {
    servicesCleanup?.();
    servicesCleanup = initServicesCascade();
  });
</script>

<style>
  /* Services cascade animation */
  .services-container .service-first {
    opacity: 0;
    transition: opacity 0.5s ease-out;
  }

  /* Cloud Solutions - flies out from behind first, stays on top */
  .services-container .service-mid-0 {
    opacity: 0;
    transform: translateY(-40px);
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    position: relative;
    z-index: 10;
  }

  /* CRM - flies out from behind Cloud (starts hidden behind Cloud) */
  .services-container .service-mid-1 {
    opacity: 0;
    transform: translateX(-50%);
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    position: relative;
    z-index: 5;
  }

  .services-container .service-last {
    opacity: 0;
    transform: translateY(-40px);
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
  }

  /* First service fades in */
  .services-container.first-in .service-first {
    opacity: 1;
  }

  /* Cloud Solutions flies in */
  .services-container.cloud-in .service-mid-0 {
    opacity: 1;
    transform: translateY(0);
  }

  /* CRM flies out from behind Cloud */
  .services-container.crm-in .service-mid-1 {
    opacity: 1;
    transform: translateX(0);
  }

  /* Last service flies out from behind */
  .services-container.last-in .service-last {
    opacity: 1;
    transform: translateY(0);
  }

  /* Service card content animations */
  .service-icon-anim {
    opacity: 0;
    transform: scale(0);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }

  .service-icon-anim.visible {
    opacity: 1;
    transform: scale(1);
  }

  .service-desc {
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }

  .service-desc.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .feature-item {
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }

  .feature-item.visible {
    opacity: 1;
    transform: translateX(0);
  }

  /* Logo items animation */
  .logo-item {
    opacity: 0;
    transform: scale(0.8) translateY(20px);
    transition: opacity 0.4s ease-out, transform 0.4s ease-out;
  }

  .logo-item.visible {
    opacity: 1;
    transform: scale(1) translateY(0);
  }

  /* Disable animations when preference set */
  [data-animations="disabled"] .services-container .service-first,
  [data-animations="disabled"] .services-container .service-mid-0,
  [data-animations="disabled"] .services-container .service-mid-1,
  [data-animations="disabled"] .services-container .service-last,
  [data-animations="disabled"] .service-icon-anim,
  [data-animations="disabled"] .service-desc,
  [data-animations="disabled"] .feature-item,
  [data-animations="disabled"] .logo-item {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
  }
</style>
