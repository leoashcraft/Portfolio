---
import { services } from '../../data/skills';
import { site } from '../../data/site';
import SectionHeader from '../common/SectionHeader.astro';
import ArcadeDecorations from '../common/ArcadeDecorations.astro';
import Icon from '../ui/Icon.astro';
---

<section id="offer" class="section section-arcade" aria-labelledby="offer-heading">
  <!-- Neon Top Border -->
  <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-neon-cyan/50 to-transparent"></div>

  <!-- Floating Arcade Decorations -->
  <ArcadeDecorations variant="offer" />

  <div class="max-w-6xl mx-auto relative z-10">
    {/* Skills Section - COMMENTED OUT
    <div class="mb-20">
      <h3 class="text-2xl font-bold text-white text-center mb-8">
        {site.sections.about.skillsTitle} <span class="gradient-text">{site.sections.about.skillsTitleHighlight}</span>
      </h3>

      <div class="grid md:grid-cols-3 gap-6">
        {
          skills.map((category) => (
            <div class="card">
              <p class="text-lg font-semibold text-white mb-4">
                {category.name}
              </p>
              <div class="space-y-3">
                {category.skills.slice(0, 5).map((skill) => (
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-300">{skill.name}</span>
                      <span class="text-neon-pink">{skill.level}%</span>
                    </div>
                    <div class="h-2 bg-night-700/50 rounded-full overflow-hidden border border-neon-pink/20">
                      <div
                        class="h-full bg-gradient-to-r from-neon-pink via-neon-purple to-neon-orange rounded-full transition-all duration-1000"
                        style={`width: ${skill.level}%; box-shadow: 0 0 10px rgba(255, 0, 255, 0.4);`}
                        role="progressbar"
                        aria-valuenow={skill.level}
                        aria-valuemin="0"
                        aria-valuemax="100"
                        aria-label={`${skill.name}: ${skill.level}%`}
                      />
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))
        }
      </div>
    </div>
    */}
  </div>

  <!-- Services Section — full width, outside max-w-6xl -->
  <div class="services-section relative z-10">
    <div class="services-container services-hscroll">
      <!-- Section Header pinned inside the sticky container -->
      <div class="services-header">
        <SectionHeader
          title={site.sections.about.title}
          titleHighlight={site.sections.about.titleHighlight}
          subtitle={site.sections.about.subtitle}
          headingId="offer-heading"
        />
      </div>

      <div class="services-hscroll-track">
        {/* First service */}
        <div class="service-panel">
        <div class="card card-highlighted group service-card service-first">
          <div class="service-icon service-icon-anim w-12 h-12 rounded-xl bg-gradient-to-br from-neon-pink/20 to-neon-purple/20 flex items-center justify-center mb-4 group-hover:from-neon-pink/30 group-hover:to-neon-purple/30 transition-colors border border-neon-pink/20">
            <svg class="w-6 h-6 text-neon-pink" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
          </div>
          <p class="service-card-title text-[24px] font-semibold text-white mb-2" data-title={services[0].title}></p>
          <p class="service-desc text-gray-400 text-[18px] mb-4" set:html={services[0].description}></p>
          <ul class="service-features space-y-2">
            {services[0].features.map((feature, index) => (
              <li class="feature-item flex items-center gap-2 text-[18px] text-gray-300" style={`--feature-index: ${index}`}>
                <Icon name="checkmark" size="sm" class="text-neon-green shrink-0" />
                <span class="feature-text">{feature}</span>
              </li>
            ))}
          </ul>
        </div>
        </div>

        {/* Cloud Solutions */}
        <div class="service-panel">
        <div class="card card-highlighted group service-card service-mid-0">
          <div class="service-icon service-icon-anim w-12 h-12 rounded-xl bg-gradient-to-br from-neon-pink/20 to-neon-purple/20 flex items-center justify-center mb-4 group-hover:from-neon-pink/30 group-hover:to-neon-purple/30 transition-colors border border-neon-pink/20">
            <svg
              class="w-6 h-6 text-neon-yellow"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
              />
            </svg>
          </div>
          <p class="service-card-title text-[24px] font-semibold text-white mb-2" data-title={services[1].title}></p>
          <p class="service-desc text-gray-400 text-[18px] mb-4" set:html={services[1].description}></p>
          <ul class="service-features space-y-2">
            {services[1].features.map((feature, index) => (
              <li class="feature-item flex items-center gap-2 text-[18px] text-gray-300" style={`--feature-index: ${index}`}>
                <Icon name="checkmark" size="sm" class="text-neon-green shrink-0" />
                <span class="feature-text">{feature}</span>
              </li>
            ))}
          </ul>
        </div>
        </div>

        {/* CRM & Integration */}
        <div class="service-panel">
        <div class="card card-highlighted group service-card service-mid-1">
          <div class="service-icon service-icon-anim w-12 h-12 rounded-xl bg-gradient-to-br from-neon-pink/20 to-neon-purple/20 flex items-center justify-center mb-4 group-hover:from-neon-pink/30 group-hover:to-neon-purple/30 transition-colors border border-neon-pink/20">
            <svg
              class="w-6 h-6 text-neon-orange"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"
              />
            </svg>
          </div>
          <p class="service-card-title text-[24px] font-semibold text-white mb-2" data-title={services[2].title}></p>
          <p class="service-desc text-gray-400 text-[18px] mb-4" set:html={services[2].description}></p>
          <ul class="service-features space-y-2">
            {services[2].features.map((feature, index) => (
              <li class="feature-item flex items-center gap-2 text-[18px] text-gray-300" style={`--feature-index: ${index}`}>
                <Icon name="checkmark" size="sm" class="text-neon-green shrink-0" />
                <span class="feature-text">{feature}</span>
              </li>
            ))}
          </ul>
        </div>
        </div>

        {/* Logo & Branding */}
        {services[3] && (
          <div class="service-panel">
          <div class="card card-highlighted group relative overflow-hidden service-card service-last">
            <div class="service-icon service-icon-anim w-12 h-12 rounded-xl bg-gradient-to-br from-neon-pink/20 to-neon-purple/20 flex items-center justify-center mb-4 group-hover:from-neon-pink/30 group-hover:to-neon-purple/30 transition-colors border border-neon-pink/20">
              <svg
                class="w-6 h-6 text-neon-cyan"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
                />
              </svg>
            </div>
            <p class="service-card-title text-[24px] font-semibold text-white mb-2" data-title={services[3].title}></p>
            <p class="service-desc text-gray-400 text-[18px] mb-4" set:html={services[3].description}></p>
            <div class="logo-gallery grid grid-cols-3 gap-4 md:gap-16 mt-4 px-2 md:px-8">
              <button class="logo-item flex items-center justify-center h-[200px] cursor-pointer logo-thumbnail" data-src="/img/logos/golden-lighting-co.avif" data-alt="Golden Lighting Co. logo">
                <div class="logo-image-wrapper relative">
                  <img src="/img/logos/golden-lighting-co.avif" alt="Golden Lighting Co. logo" class="max-h-[200px] max-w-full object-contain" />
                  <div class="logo-shimmer absolute inset-0 opacity-0 pointer-events-none" style="mask-image: url('/img/logos/golden-lighting-co.avif'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('/img/logos/golden-lighting-co.avif'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;"></div>
                </div>
              </button>
              <button class="logo-item flex items-center justify-center h-[200px] cursor-pointer logo-thumbnail" data-src="/img/logos/honey-bee-window-cleaning.avif" data-alt="Honey Bee Window Cleaning logo">
                <div class="logo-image-wrapper relative">
                  <img src="/img/logos/honey-bee-window-cleaning.avif" alt="Honey Bee Window Cleaning logo" class="max-h-[200px] max-w-full object-contain" />
                  <div class="logo-shimmer absolute inset-0 opacity-0 pointer-events-none" style="mask-image: url('/img/logos/honey-bee-window-cleaning.avif'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('/img/logos/honey-bee-window-cleaning.avif'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;"></div>
                </div>
              </button>
              <button class="logo-item flex items-center justify-center h-[200px] cursor-pointer logo-thumbnail" data-src="/img/logos/eagle-it.avif" data-alt="Eagle IT logo">
                <div class="logo-image-wrapper relative">
                  <img src="/img/logos/eagle-it.avif" alt="Eagle IT logo" class="max-h-[200px] max-w-full object-contain" />
                  <div class="logo-shimmer absolute inset-0 opacity-0 pointer-events-none" style="mask-image: url('/img/logos/eagle-it.avif'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('/img/logos/eagle-it.avif'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;"></div>
                </div>
              </button>
            </div>

            <!-- Image Modal - inside card -->
            <div id="logo-modal" class="absolute inset-0 z-20 hidden items-center justify-center bg-black/90 backdrop-blur-sm rounded-2xl">
              <button id="modal-close" class="absolute top-2 right-2 z-30 text-white text-[3rem] leading-none hover:text-neon-pink transition-colors w-12 h-12 flex items-center justify-center pb-1">&times;</button>
              <img id="modal-image" src="" alt="" class="max-h-[200px] max-w-[80%] object-contain" />
            </div>
          </div>
          </div>
        )}
        </div>{/* end .services-hscroll-track */}

        {/* Panel indicator dots */}
        <div class="hscroll-indicators">
          {services.map((_, i) => (
            <button class={`hscroll-dot${i === 0 ? ' active' : ''}`} data-panel={i} aria-label={`Go to service ${i + 1}`}></button>
          ))}
        </div>
      </div>
    </div>
</section>

<script>
  import { initIconFlips } from '../../lib/icon-flip';
  import { initSectionParallax } from '../../lib/parallax';

  let iconCleanup: () => void;

  function initServiceIconFlips() {
    iconCleanup?.();
    iconCleanup = initIconFlips({ selector: '.service-icon' });
  }

  function initLogoModal() {
    const modal = document.getElementById('logo-modal');
    const modalImage = document.getElementById('modal-image') as HTMLImageElement;
    const modalClose = document.getElementById('modal-close');
    const thumbnails = document.querySelectorAll('.logo-thumbnail');

    if (!modal || !modalImage || !modalClose) return;

    thumbnails.forEach((thumb) => {
      thumb.addEventListener('click', () => {
        const src = thumb.getAttribute('data-src');
        const alt = thumb.getAttribute('data-alt');
        if (src) {
          modalImage.src = src;
          modalImage.alt = alt || '';
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }
      });
    });

    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
    });
  }

  function initLogoShimmer() {
    const wrappers = document.querySelectorAll('.logo-image-wrapper');

    wrappers.forEach((wrapper) => {
      const shimmer = wrapper.querySelector('.logo-shimmer');
      const img = wrapper.querySelector('img');
      if (!shimmer || !img) return;

      let isAnimating = false;

      img.addEventListener('mouseenter', () => {
        if (isAnimating) return;
        isAnimating = true;
        shimmer.classList.add('shimmer-active');
      });

      shimmer.addEventListener('animationend', () => {
        shimmer.classList.remove('shimmer-active');
        isAnimating = false;
      });

      img.addEventListener('mouseleave', () => {
        isAnimating = false;
      });
    });
  }

  function initAbout() {
    initServiceIconFlips();
    initSectionParallax('offer');
    initLogoModal();
    initLogoShimmer();
  }

  // ============================================
  // Horizontal Scroll Services
  // ============================================
  let hscrollCleanup: (() => void) | undefined;

  interface PanelState {
    panel: HTMLElement;
    icon: HTMLElement | null;
    title: HTMLElement | null;
    titleText: string;
    desc: HTMLElement | null;
    features: HTMLElement[];
    logos: HTMLElement[];
    lastTitleProgress: number;
    revealed: boolean;
  }

  function isMobile(): boolean {
    return false; // scroll panels now work on all screen sizes
  }

  // Lazy-loaded snap sound — created on first play to avoid autoplay restrictions
  let snapSound: HTMLAudioElement | null = null;
  const SNAP_SOUND_URL = '/sounds/fast-swipe-48158.mp3';

  function getSnapSound(): HTMLAudioElement | null {
    if (!snapSound) {
      try {
        snapSound = new Audio(SNAP_SOUND_URL);
        snapSound.volume = 0.3;
      } catch (_) { return null; }
    }
    return snapSound;
  }

  let lastSoundTime = 0;
  function playSnapSound() {
    if (document.documentElement.getAttribute('data-sounds') === 'disabled') return;
    const now = Date.now();
    if (now - lastSoundTime < 1000) return;
    lastSoundTime = now;
    const snd = getSnapSound();
    if (!snd) return;
    snd.currentTime = 0;
    snd.play().catch(() => {});
  }

  function initHorizontalScroll() {
    const servicesSection = document.querySelector('.services-section') as HTMLElement;
    const container = document.querySelector('.services-container') as HTMLElement;
    const track = document.querySelector('.services-hscroll-track') as HTMLElement;
    const dots = document.querySelectorAll('.hscroll-dot') as NodeListOf<HTMLElement>;

    if (!servicesSection || !container || !track) return () => {};

    const panels = track.querySelectorAll('.service-panel') as NodeListOf<HTMLElement>;
    const panelCount = panels.length;

    if (panelCount === 0) return () => {};

    // Build panel states for content animation
    const panelStates: PanelState[] = [];
    panels.forEach((panel) => {
      const titleEl = panel.querySelector('.service-card-title') as HTMLElement;
      const titleText = titleEl?.dataset.title || '';

      panelStates.push({
        panel,
        icon: panel.querySelector('.service-icon-anim'),
        title: titleEl,
        titleText,
        desc: panel.querySelector('.service-desc'),
        features: Array.from(panel.querySelectorAll('.feature-item')),
        logos: Array.from(panel.querySelectorAll('.logo-item')),
        lastTitleProgress: -1,
        revealed: false,
      });
    });

    // If animations disabled or mobile, show all content immediately
    const animDisabled = document.documentElement.getAttribute('data-animations') === 'disabled';
    if (animDisabled || isMobile()) {
      panelStates.forEach((state) => {
        const card = state.panel.querySelector('.service-card');
        if (card) card.classList.add('card-in');
        if (state.icon) state.icon.classList.add('visible');
        if (state.title) state.title.textContent = state.titleText;
        if (state.desc) state.desc.classList.add('visible');
        state.features.forEach((f) => f.classList.add('visible'));
        state.logos.forEach((l) => l.classList.add('visible'));
        state.revealed = true;
      });
      if (isMobile()) {
        servicesSection.style.height = '';
        return () => {};
      }
    }

    // Measure nav height and set CSS variable so sticky offsets below it
    const nav = document.getElementById('main-nav');
    const navH = nav ? nav.offsetHeight : 60;
    container.style.setProperty('--nav-h', `${navH}px`);

    // Equalize panel heights: temporarily show all content so we can measure
    // natural heights, then set all panels to the tallest.
    // Kill transitions during measurement so nothing flashes on screen.
    track.style.transition = 'none';
    panels.forEach((p) => {
      p.style.minHeight = '';
      p.style.transition = 'none';
    });
    panelStates.forEach((state) => {
      const card = state.panel.querySelector('.service-card') as HTMLElement;
      if (card) { card.style.transition = 'none'; card.style.opacity = '1'; card.style.transform = 'none'; }
      if (state.icon) { (state.icon as HTMLElement).style.transition = 'none'; (state.icon as HTMLElement).style.opacity = '1'; (state.icon as HTMLElement).style.transform = 'none'; }
      if (state.title) state.title.textContent = state.titleText;
      if (state.desc) { (state.desc as HTMLElement).style.transition = 'none'; (state.desc as HTMLElement).style.opacity = '1'; (state.desc as HTMLElement).style.transform = 'none'; }
      state.features.forEach((f) => { (f as HTMLElement).style.transition = 'none'; (f as HTMLElement).style.opacity = '1'; (f as HTMLElement).style.transform = 'none'; });
      state.logos.forEach((l) => { (l as HTMLElement).style.transition = 'none'; (l as HTMLElement).style.opacity = '1'; (l as HTMLElement).style.transform = 'none'; });
    });
    // Force layout to measure
    let maxH = 0;
    panels.forEach((p) => {
      if (p.scrollHeight > maxH) maxH = p.scrollHeight;
    });
    panels.forEach((p) => { p.style.minHeight = `${maxH}px`; });
    // Reset: clear inline styles and content for non-disabled animations
    if (!animDisabled) {
      panelStates.forEach((state) => {
        state.revealed = false;
        state.lastTitleProgress = -1;
        const card = state.panel.querySelector('.service-card') as HTMLElement;
        if (card) { card.style.transition = ''; card.style.opacity = ''; card.style.transform = ''; }
        if (state.icon) { (state.icon as HTMLElement).style.transition = ''; (state.icon as HTMLElement).style.opacity = ''; (state.icon as HTMLElement).style.transform = ''; }
        if (state.title) state.title.textContent = '';
        if (state.desc) { (state.desc as HTMLElement).style.transition = ''; (state.desc as HTMLElement).style.opacity = ''; (state.desc as HTMLElement).style.transform = ''; }
        state.features.forEach((f) => { (f as HTMLElement).style.transition = ''; (f as HTMLElement).style.opacity = ''; (f as HTMLElement).style.transform = ''; });
        state.logos.forEach((l) => { (l as HTMLElement).style.transition = ''; (l as HTMLElement).style.opacity = ''; (l as HTMLElement).style.transform = ''; });
      });
    }
    // Restore track transition
    track.style.transition = '';
    panels.forEach((p) => { p.style.transition = ''; });

    // Each panel is 100% of container width — step is the container width
    const stepPx = container.offsetWidth;

    // Set the section height to create scroll space:
    // 40vh per panel — short scroll to advance each card
    const scrollPerPanel = window.innerHeight * 0.7;
    servicesSection.style.height = `${window.innerHeight + (panelCount - 1) * scrollPerPanel}px`;

    let ticking = false;
    let currentPanel = 0;
    let snappedPanel = 0;
    let panel0Revealed = false;
    let wasPastSection = false;
    let resetLock = false;

    // Track active timeouts/intervals so we can clear them on reset
    let activeTimers: ReturnType<typeof setTimeout>[] = [];
    let activeIntervals: ReturnType<typeof setInterval>[] = [];

    function revealPanelContent(state: PanelState) {
      // Always replay — reset first then animate
      state.revealed = true;

      // Card slides in
      const card = state.panel.querySelector('.service-card');
      if (card) card.classList.add('card-in');

      // Icon pops in
      if (state.icon) state.icon.classList.add('visible');

      // Title types out
      if (state.title && state.titleText) {
        state.title.textContent = '';
        let charIndex = 0;
        const typeInterval = setInterval(() => {
          charIndex++;
          if (state.title) {
            state.title.textContent = state.titleText.slice(0, charIndex);
          }
          if (charIndex >= state.titleText.length) {
            clearInterval(typeInterval);
          }
        }, 30);
        activeIntervals.push(typeInterval);
      }

      // Description fades in after a short delay
      activeTimers.push(setTimeout(() => {
        if (state.desc) state.desc.classList.add('visible');
      }, 300));

      // Features cascade in
      state.features.forEach((feature, index) => {
        activeTimers.push(setTimeout(() => {
          feature.classList.add('visible');
        }, 500 + index * 100));
      });

      // Logos cascade in
      state.logos.forEach((logo, index) => {
        activeTimers.push(setTimeout(() => {
          logo.classList.add('visible');
        }, 400 + index * 120));
      });
    }

    function resetPanelContent(state: PanelState) {
      state.revealed = false;
      state.lastTitleProgress = -1;

      const card = state.panel.querySelector('.service-card');
      if (card) card.classList.remove('card-in');
      if (state.icon) state.icon.classList.remove('visible');
      if (state.title) state.title.textContent = '';
      if (state.desc) state.desc.classList.remove('visible');
      state.features.forEach((f) => f.classList.remove('visible'));
      state.logos.forEach((l) => l.classList.remove('visible'));
    }

    function resetAllPanels() {
      // Clear any in-flight animations
      activeTimers.forEach((t) => clearTimeout(t));
      activeIntervals.forEach((t) => clearInterval(t));
      activeTimers = [];
      activeIntervals = [];

      panelStates.forEach((state) => resetPanelContent(state));
    }

    function updateDots(activeIndex: number) {
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === activeIndex);
      });
    }

    function snapTo(panelIndex: number) {
      const clamped = Math.max(0, Math.min(panelIndex, panelCount - 1));
      if (clamped === snappedPanel) return;
      snappedPanel = clamped;

      playSnapSound();

      // Reset all panels so the incoming one replays its animation fresh
      resetAllPanels();

      // Translate by panel index * step size
      const translatePx = clamped * stepPx;
      track.style.transition = 'transform 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      track.style.transform = `translateX(-${translatePx}px)`;

      updateDots(clamped);
      currentPanel = clamped;

      // Reveal content for the active panel
      revealPanelContent(panelStates[clamped]);
    }

    function onScroll() {
      if (ticking) return;
      ticking = true;

      requestAnimationFrame(() => {
        if (resetLock) { ticking = false; return; }

        const sectionRect = servicesSection.getBoundingClientRect();
        const sectionTop = -sectionRect.top;
        const totalScrollable = servicesSection.offsetHeight - window.innerHeight;

        if (sectionTop < 0) {
          // Haven't reached the section yet
          if (snappedPanel !== 0) {
            snappedPanel = 0;
            currentPanel = 0;
            panel0Revealed = false;
            track.style.transition = 'transform 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            track.style.transform = 'translateX(0)';
            updateDots(0);
          }

          wasPastSection = false;

          // Reset all panels when scrolled well above
          if (sectionRect.top > window.innerHeight * 0.5) {
            panel0Revealed = false;
            panelStates.forEach((state) => resetPanelContent(state));
          } else if (!panel0Revealed) {
            panel0Revealed = true;
            playSnapSound();
            revealPanelContent(panelStates[0]);
          }
        } else if (sectionTop >= totalScrollable) {
          // Past the section — snap to last
          wasPastSection = true;
          snapTo(panelCount - 1);
        } else {
          // In the sticky range
          if (wasPastSection) {
            // Returning from below — lock scroll, reset to panel 0
            wasPastSection = false;
            resetLock = true;
            snappedPanel = 0;
            currentPanel = 0;
            panel0Revealed = false;
            panelStates.forEach((state) => resetPanelContent(state));
            track.style.transition = 'none';
            track.style.transform = 'translateX(0)';
            updateDots(0);
            void track.offsetHeight;
            setTimeout(() => {
              panel0Revealed = true;
              revealPanelContent(panelStates[0]);
              resetLock = false;
            }, 600);
          } else {
            // Normal scrolling — determine which panel to snap to
            const progress = sectionTop / totalScrollable;
            const targetPanel = Math.round(progress * (panelCount - 1));
            snapTo(targetPanel);
          }
        }

        ticking = false;
      });
    }

    // Dot click handlers
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const panelIndex = parseInt(dot.dataset.panel || '0', 10);
        const totalScrollable = servicesSection.offsetHeight - window.innerHeight;
        const targetScroll = servicesSection.offsetTop + (panelIndex / (panelCount - 1)) * totalScrollable;
        window.scrollTo({ top: targetScroll, behavior: 'smooth' });
      });
    });

    // Handle resize — full reinit via debounce
    let resizeTimer: ReturnType<typeof setTimeout>;
    function onResize() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        // Cleanup and reinit will be handled by the caller
        hscrollCleanup?.();
        hscrollCleanup = initHorizontalScroll();
      }, 200);
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize, { passive: true });

    // Initial state
    onScroll();

    return () => {
      window.removeEventListener('scroll', onScroll);
      window.removeEventListener('resize', onResize);
      clearTimeout(resizeTimer);
    };
  }

  // Initialize when DOM is ready
  function initAll() {
    initAbout();
    hscrollCleanup?.();
    hscrollCleanup = initHorizontalScroll();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
  document.addEventListener('astro:after-swap', initAll);

  window.addEventListener('animations-change', () => {
    hscrollCleanup?.();
    hscrollCleanup = initHorizontalScroll();
  });
</script>

<style>
  /* ============================================
     Horizontal Scroll Services Section
     ============================================ */

  /* The outer section creates vertical scroll space.
     Height = (number of panels) * 100vh so that scrolling
     through this tall section drives the horizontal movement. */
  /* Offer section with scroll-hijacked horizontal panels */
  :global(#offer) {
    scroll-snap-align: start;
    min-height: auto;
  }

  .services-section {
    position: relative;
    /* JS will set height dynamically based on panel count */
  }

  /* Sticky container pins at the top of the viewport,
     offset below the nav bar (--nav-h set by JS) */
  .services-container.services-hscroll {
    position: sticky;
    top: var(--nav-h, 60px);
    height: calc(100vh - var(--nav-h, 60px));
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Header stays at top inside sticky */
  .services-header {
    flex-shrink: 0;
    padding: 2rem 5% 0;
  }

  /* The inner track that gets translated horizontally */
  .services-hscroll-track {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    will-change: transform;
    flex: 1;
    align-items: center;
    width: 100%;
  }

  /* Each panel takes full container width so adjacent panels are off-screen */
  .services-hscroll-track .service-panel {
    flex: 0 0 100%;
    width: 100%;
    overflow-y: auto;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    padding: 0 5%;
  }

  /* Card content inside each panel is capped at 1000px */
  .services-hscroll-track .service-panel > .card {
    width: 100%;
    max-width: 1000px;
  }

  /* Service card entrance animation — swipes in from right */
  .service-card {
    opacity: 0;
    transform: translateX(100%);
    transition: opacity 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .service-card.card-in {
    opacity: 1;
    transform: translateX(0);
  }

  /* Service card content animations (kept from cascade) */
  .service-icon-anim {
    opacity: 0;
    transform: scale(0);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }

  .service-icon-anim.visible {
    opacity: 1;
    transform: scale(1);
  }

  .service-desc {
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }

  .service-desc.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .feature-item {
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }

  .feature-item.visible {
    opacity: 1;
    transform: translateX(0);
  }

  /* Logo items animation */
  .logo-item {
    opacity: 0;
    transform: scale(0.8) translateY(20px);
    transition: opacity 0.4s ease-out, transform 0.4s ease-out;
  }

  .logo-item.visible {
    opacity: 1;
    transform: scale(1) translateY(0);
  }

  /* Panel indicator dots */
  .hscroll-indicators {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.75rem;
    z-index: 20;
  }

  .hscroll-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255, 0, 255, 0.4);
    background: transparent;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .hscroll-dot.active {
    background: var(--color-neon-pink);
    border-color: var(--color-neon-pink);
    box-shadow: 0 0 10px rgba(255, 0, 255, 0.6);
  }

  /* Mobile: tighter padding for scroll panels */
  @media (max-width: 767px) {
    .services-header {
      padding: 1rem 1rem 0;
    }

    .services-hscroll-track .service-panel {
      padding: 0 1rem;
    }
  }

  /* Disable animations when preference set */
  [data-animations="disabled"] .service-card,
  [data-animations="disabled"] .service-icon-anim,
  [data-animations="disabled"] .service-desc,
  [data-animations="disabled"] .feature-item,
  [data-animations="disabled"] .logo-item {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
  }
</style>
